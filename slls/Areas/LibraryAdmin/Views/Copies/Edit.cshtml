@using System.Collections.Generic
@using VortexSoft.Bootstrap
@using Westwind.Globalization
@model slls.ViewModels.CopyDetailsEditViewModel

@{
    ViewBag.VolumesBadge = "";
    ViewBag.LoansBadge = "";
}

@if (ViewBag.VolumesCount > 0)
{
    ViewBag.VolumesBadge = " <span class='badge'>" + ViewBag.VolumesCount + "</span>";
}

@if (ViewBag.LoansCount > 0)
{
    ViewBag.LoansBadge = " <span class='badge'>" + ViewBag.LoansCount + "</span>";
}

@if (ViewBag.PartsCount > 0)
{
    ViewBag.PartsBadge = " <span class='badge'>" + ViewBag.PartsCount + "</span>";
}

<div>
    @if (ViewBag.RecordCount > 1)
    {
        <span class="pull-right">@Html.Partial("_PaginateDetails", Model)</span>
    }

    <h2>@ViewBag.Title</h2>
    <div class="alert alert-info">

        @Html.Partial("_SelectCopy")

        <div class="row" style="margin-right: 0">
            <div class="col-md-12" style="margin-top: 10px;">
                <span id="saveDetails" class="pull-right" style="display: none;">
                    <button type="button" id="btnSaveCopyDetails" value="Save Copy Details" class="btn btn-success"><span aria-hidden="true" class="glyphicon glyphicon-ok"></span> Save Copy Details</button>
                </span>
                <span id="saveCancellations" class="pull-right" style="display: none;">
                    <button type="button" id="btnSaveCancellations" value="Save Cancellations" class="btn btn-success"><span aria-hidden="true" class="glyphicon glyphicon-ok"></span> Save Cancellations</button>
                </span>
                <a href="@Url.Action("Add", "Copies", new {id = @Model.TitleId, returnAction = "Edit", returnController = "Copies"})" title="Add new @DbRes.T("Copies.Copy", "FieldDisplayName")" class="btn btn-primary"><span aria-hidden="true" class="glyphicon glyphicon-plus-sign"></span> Add New @DbRes.T("Copies.Copy", "FieldDisplayName")</a>
            </div>
        </div>
    </div>
</div>

@Html.Partial("_PostSuccess")

@using (var tabs = Html.Bootstrap().Begin(new Tabs()))
{
    tabs.Tab(DbRes.T("Copies.Copy", "FieldDisplayName") + " Details", "details");
    tabs.Tab(DbRes.T("CopyItems", "EntityType") + ViewBag.VolumesBadge, "copyitems");
    if (Model.IsSerialsAdmin)
    {
        tabs.Tab(DbRes.T("Holdings", "EntityType") + ViewBag.PartsBadge, "holdings");
    }
    if (Model.IsSerialsAdmin)
    {
        tabs.Tab(DbRes.T("Cancellations", "EntityType"), "cancellations");
    }
    if (Model.IsLoansAdmin)
    {
        tabs.Tab(DbRes.T("Loans", "EntityType") + ViewBag.LoansBadge, "loans");
    }
    tabs.Tab("<span class = 'glyphicon glyphicon-share-alt'></span> Go to " + DbRes.T("Titles.Title", "FieldDisplayName"), "BackToTitle");

    using (tabs.BeginPanel())
    {
        <br />
        <div>
            @Html.Label(DbRes.T("Titles.Title", "FieldDisplayName"))
        </div>
        <div>
            <span class="form-control"><a href="@Url.Action("Edit", "Titles", new {id = @Model.TitleId}, null)" title="Go to @DbRes.T("Titles.Title", "FieldDisplayName")">@Model.Title</a></span>
        </div>
        <div id="CopyDetails">
            @Html.Partial("_CopyDetails", Model)
        </div>
    }
    using (tabs.BeginPanel())
    {
        <br />
        <div class="alert alert-info"><span class="glyphicon glyphicon-info-sign"></span> Create a @DbRes.T("CopyItems.Copy_Item", "FieldDisplayName") for each individual volume if it is a multi-volume work.</div>

        <div>
            @Html.Label(DbRes.T("Titles.Title", "FieldDisplayName"))
        </div>
        <div>
            <span class="form-control"><a href="@Url.Action("Edit", "Titles", new {id = @Model.TitleId}, null)" title="Go to @DbRes.T("Titles.Title", "FieldDisplayName")">@Model.Title</a></span>
        </div>
        <br />
        <p>
            <a href="@Url.Action("Add", "Volumes", new {id = Model.CopyId})" class="btn btn-primary" title="Add new"><span aria-hidden="true" class="glyphicon glyphicon-plus-sign"></span> Add New @DbRes.T("CopyItems.Copy_Item", "FieldDisplayName")</a>
        </p>
        @Html.Action("_ThumbnailDetails", "Volumes", new { id = Model.CopyId })
        <div class="form-footer">
            @if (ViewBag.RecordCount > 1)
            {
                <span class="pull-left" style="padding-right: 15px;">@Html.Partial("_PaginateDetails", Model)</span>
            }
            <a href="@Url.Action("Delete", new {id = Model.CopyId})" class="btn btn-danger modal-link" title="Delete @DbRes.T("Copies.Copy", "FieldDisplayName")"><span aria-hidden="true" class="glyphicon glyphicon-trash"></span> Delete Copy</a>
            &nbsp;&nbsp;or&nbsp;<input type="button" value="Cancel" class="btn-link" onclick="window.history.back();" />
        </div>
    }

    if (Model.IsSerialsAdmin)
    {
        using (tabs.BeginPanel())
        {
            <div id="PartsReceived">
                @Html.Action("_Holdings", "Copies", new { id = Model.CopyId })
            </div>
            <div class="form-footer">
                @if (ViewBag.RecordCount > 1)
                {
                    <span class="pull-left" style="padding-right: 15px;">@Html.Partial("_PaginateDetails", Model)</span>
                }
                <a href="@Url.Action("Delete", new {id = Model.CopyId})" class="btn btn-danger modal-link" title="Delete Copy"><span aria-hidden="true" class="glyphicon glyphicon-trash"></span> Delete Copy</a>
                &nbsp;&nbsp;or&nbsp;<input type="button" value="Cancel" class="btn-link" onclick="window.history.back();" />
            </div>
        }
    }

    if (Model.IsSerialsAdmin)
    {
        using (tabs.BeginPanel())
        {
            <div id="Cancellations">
                @Html.Partial("_Cancellations", Model)
            </div>
        }
    }

    if (Model.IsLoansAdmin)
    {
        using (tabs.BeginPanel())
        {
            <br />
            <div>
                @Html.Label(DbRes.T("Titles.Title", "FieldDisplayName"))
            </div>
            <div>
                <span class="form-control"><a href="@Url.Action("Edit", "Titles", new {id = @Model.TitleId}, null)" title="Go to @DbRes.T("Titles.Title", "FieldDisplayName")">@Model.Title</a></span>
            </div>
            <br />
            <div id="Loans">
                @Html.Action("_ItemsOnLoanByCopy", "Loans", new { id = Model.CopyId })
            </div>
            <br />
            <div class="form-footer">
                @if (ViewBag.RecordCount > 1)
                {
                    <span class="pull-left" style="padding-right: 15px;">@Html.Partial("_PaginateDetails", Model)</span>
                }
                <a href="@Url.Action("Delete", new {id = Model.CopyId})" class="btn btn-danger modal-link" title="Delete Copy"><span aria-hidden="true" class="glyphicon glyphicon-trash"></span> Delete Copy</a>
                &nbsp;&nbsp;or&nbsp;<input type="button" value="Cancel" class="btn-link" onclick="window.history.back();" />
            </div>
        }
    }

    using (tabs.BeginPanel())
    {
        <br /><br />
        <div class="form-horizontal">
            <div class="form-group">
                <div class="col-md-12">
                    <p>Please wait ... loading @DbRes.T("Titles.Title", "FieldDisplayName") details</p>
                </div>
            </div>
        </div>
    }
}

@Html.Hidden("AutoSuggestUrl", @Url.Action("AutoComplete", "Copies"))
@Html.Hidden("BackToTitleUrl", @Url.Action("Edit", "Titles", new { id = "REPLACEME" }));
@Html.Hidden("DestUrl", @Url.Action("Edit", "Copies", new { id = "REPLACEME" }))

@section scripts {
    <script src="@Url.Content("~/Scripts/jquery.mcautocomplete.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/_SelectCopy.js")" type="text/javascript"></script>


    <script type="text/javascript">

        $(document).ready(function() {
            // hide the alert after 6 seconds ...
            setTimeout(function() {
                $(".alert-dismissable").alert('close');
            }, 6000);
        });

        $(function() {
            $('a[data-toggle="tab"]').on('click', function(e) {
                var target = $(e.target).attr("href"); // active tab
                if (target === "#BackToTitle") {
                    var url = $("#BackToTitleUrl").val();
                    window.location.href = url.replace('REPLACEME', @Model.TitleId);
                } else {
                    // Save the latest tab:
                    sessionStorage.setItem('lastTab_EditCopy', target);
                }

                if (target == "#details") {
                    $('#saveDetails').show();
                } else {
                    $('#saveDetails').hide();
                }

                if (target == "#cancellations") {
                    $('#saveCancellations').show();
                } else {
                    $('#saveCancellations').hide();
                }
            });

            // Go to the latest tab, if it exists:
            var lastTab = sessionStorage.getItem('lastTab_EditCopy');

            if (lastTab) {
                if (lastTab !== "#BackToTitle") {
                    $('a[href="' + lastTab + '"]').click();
                }
            } else {
                $('a[href="#details"]').click();
            }
        });

        $('#btnSaveCopyDetails').click(function(e) {
            $('#_copyDetails').submit();
        });

        $('#btnSaveCancellations').click(function (e) {
            $('#_cancellations').submit();
        });

    </script>
}